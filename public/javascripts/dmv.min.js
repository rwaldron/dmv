/*! dmv - v0.3.0 - 8/20/2012
* https://github.com/rwldrn/dmv
* Copyright (c) 2012 Rick Waldron <waldron.rick@gmail.com>; Licensed MIT */
(function(a,b){var c,d;c=function(d,e){var f=localStorage.getItem("dmv-id");f||(f=c.id(),localStorage.setItem("dmv-id",f)),this.id=f,this.container=document.querySelector(d),this.media=this.fixture("video",this.id),this.canvas=this.fixture("canvas",this.id),this.context=this.canvas.getContext("2d"),this.socket=e,this.dataUri="",b.getUserMedia({video:!0},function(b){var c;b.label&&b.readyState===1&&(c=a.URL.createObjectURL(b)),this.media.src=c&&c||b,this.media.play(),this.media.addEventListener("loadedmetadata",function(){this.media.play()}.bind(this),!1),this.media.addEventListener("timeupdate",function(){this.draw()}.bind(this),!1)}.bind(this),function(){console.log(arguments)})},c.prototype.draw=function(){this.context.drawImage(this.media,0,0,this.canvas.width,this.canvas.height)},c.prototype.capture=function(a){var b=this.canvas.toDataURL();this.socket.emit("capture",{id:this.id,captured:b}),a(b)},c.prototype.fixture=function(a,b){var c=document.createElement(a),d;return c.id=a[0]+"_"+b,this.container||(this.container=document.body),a==="canvas"&&(d=document.querySelector("video[id$='"+b+"']"),setTimeout(function e(){d.videoWidth>0?(c.width=d.videoWidth,c.height=d.videoHeight,c.style.visibility="hidden",this.container.style.width=d.videoWidth+"px"):setTimeout(e,10)},10)),this.container.appendChild(c),c},c.id=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=Math.random()*16|0;return(a==="x"?b:b&3|8).toString(16)}).toUpperCase()},d={socket:null,operator:null,init:function(a,b){d.socket=b,d.operator=new c(a,b),this.listen(d.operator.media)},listen:function(a){a?a.addEventListener("click",d.operator.capture.bind(d.operator),!1):setTimeout(function(){d.listen(a)},10)}},a.DMV=d,a.Operator=c})(typeof window=="object"&&window||this,this.navigator);